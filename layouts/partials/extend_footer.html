<footer class="custom-min-footer">
  <p>{{ site.Params.footer.text | default "Progress, Not Perfection" }}</p>
</footer>

<div id="copy-toast" class="copy-toast" role="status" aria-live="polite" aria-atomic="true"></div>

<script>
  (function () {
    var toast = document.getElementById("copy-toast");
    var timer = null;
    var externalTrackCache = {};

    function showToast(message) {
      if (!toast) return;
      toast.textContent = message;
      toast.classList.add("is-visible");
      if (timer) window.clearTimeout(timer);
      timer = window.setTimeout(function () {
        toast.classList.remove("is-visible");
      }, 1700);
    }

    function fallbackCopy(text) {
      var input = document.createElement("textarea");
      input.value = text;
      input.setAttribute("readonly", "");
      input.style.position = "fixed";
      input.style.opacity = "0";
      document.body.appendChild(input);
      input.select();
      var copied = false;
      try {
        copied = document.execCommand("copy");
      } catch (error) {
        copied = false;
      }
      document.body.removeChild(input);
      return copied;
    }

    function trackEvent(name, props) {
      if (!name) return;
      var payload = props || {};
      try {
        if (typeof window.plausible === "function") {
          window.plausible(name, { props: payload });
        }
      } catch (error) {
        console.warn("plausible track failed", error);
      }
      try {
        if (window.umami && typeof window.umami.track === "function") {
          window.umami.track(name, payload);
        }
      } catch (error) {
        console.warn("umami track failed", error);
      }
    }

    window.BlueDogTrack = trackEvent;

    async function copyEmail(email) {
      if (!email) return;
      var copied = false;
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(email);
          copied = true;
        } else {
          copied = fallbackCopy(email);
        }
      } catch (error) {
        copied = fallbackCopy(email);
      }
      if (copied) {
        showToast("邮箱已复制: " + email);
        trackEvent("email_copy", { email: email, page: window.location.pathname });
      } else {
        showToast("复制失败，请手动复制: " + email);
        trackEvent("email_copy_failed", { page: window.location.pathname });
      }
    }

    document.addEventListener("click", function (event) {
      var link = event.target.closest("[data-copy-email]");
      if (!link) return;
      event.preventDefault();
      var email = link.getAttribute("data-copy-email");
      copyEmail(email);
    });

    document.addEventListener("click", function (event) {
      var tagAnchor = event.target.closest(".post-tags a");
      if (tagAnchor) {
        var tagName = (tagAnchor.getAttribute("data-tag-click") || tagAnchor.textContent || "").trim();
        if (tagName) {
          trackEvent("tag_click", { tag: tagName, page: window.location.pathname });
        }
      }

      var anchor = event.target.closest("a[href]");
      if (!anchor) return;
      var href = anchor.getAttribute("href") || "";
      if (!href || href.startsWith("#") || href.startsWith("mailto:") || href.startsWith("tel:")) return;

      var targetURL;
      try {
        targetURL = new URL(anchor.href, window.location.origin);
      } catch (error) {
        return;
      }
      if (targetURL.origin === window.location.origin) return;

      var key = targetURL.href + "::" + window.location.pathname;
      if (externalTrackCache[key]) return;
      externalTrackCache[key] = true;

      trackEvent("outbound_click", {
        host: targetURL.host,
        href: targetURL.href,
        page: window.location.pathname,
      });
    });
  })();
</script>
