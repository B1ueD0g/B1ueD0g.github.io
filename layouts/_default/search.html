{{- define "main" }}
{{- $quickTags := site.Params.searchQuickTags | default (slice "零信任" "AI安全" "数据安全" "漏洞研究" "标准解读") -}}
{{- $synonyms := site.Params.searchSynonyms | default dict -}}
{{- $synonymHints := site.Params.searchSynonymHints | default (slice "零信任 ↔ zero trust" "AI安全 ↔ ai security" "威胁情报 ↔ threat intelligence") -}}
{{- $posts := where site.RegularPages "Section" "posts" -}}
{{- $posts = where $posts "Params.hiddenInHomeList" "!=" "true" -}}
{{- $posts = $posts.ByDate.Reverse -}}
{{- $years := slice -}}
{{- range $posts -}}
  {{- $years = $years | append (.Date.Format "2006") -}}
{{- end -}}
{{- $years = uniq $years -}}
{{- $filterTags := $quickTags -}}
{{- range first 18 site.Taxonomies.tags.ByCount -}}
  {{- if not (in $filterTags .Name) -}}
    {{- $filterTags = $filterTags | append .Name -}}
  {{- end -}}
{{- end -}}
{{- if gt (len $filterTags) 16 -}}
  {{- $filterTags = first 16 $filterTags -}}
{{- end -}}
{{- $searchMeta := slice -}}
{{- range $posts -}}
  {{- $searchMeta = $searchMeta | append (dict
    "title" .Title
    "permalink" .Permalink
    "relPermalink" .RelPermalink
    "year" (.Date.Format "2006")
    "date" (.Date.Format site.Params.DateFormat)
    "tags" (.Params.tags | default (slice))
  ) -}}
{{- end -}}
<header class="page-header">
  <h1>{{ .Title }}</h1>
</header>

<link rel="stylesheet" href="{{ "pagefind/pagefind-ui.css" | relURL }}">
<script src="{{ "pagefind/pagefind-ui.js" | relURL }}" defer></script>

<section class="search-guide" aria-label="search-guide">
  <p class="search-guide-text">输入关键词后按回车可跳转首条结果，也可以按年份和标签筛选。</p>
  <div class="search-guide-tags">
    <span>Suggested Tags:</span>
    {{- range $quickTags }}
    <button type="button" data-search-tag="{{ . }}">#{{ . }}</button>
    {{- end }}
  </div>
  <div class="search-guide-synonyms">
    <span>Synonyms:</span>
    {{- range $synonymHints }}
    <button type="button" data-search-hint="{{ . }}">{{ . }}</button>
    {{- end }}
  </div>
</section>

<section class="search-filters" aria-label="search-filters">
  <div class="search-filter-row">
    <span>Year:</span>
    <button type="button" data-filter-year="" class="is-active">All</button>
    {{- range $years }}
    <button type="button" data-filter-year="{{ . }}">{{ . }}</button>
    {{- end }}
  </div>
  <div class="search-filter-row">
    <span>Tag:</span>
    <button type="button" data-filter-tag="" class="is-active">All</button>
    {{- range $filterTags }}
    <button type="button" data-filter-tag="{{ . }}">#{{ . }}</button>
    {{- end }}
  </div>
</section>

<div id="search"></div>
<div id="search-recent" class="search-recent" hidden>
  <span>Recent:</span>
  <div id="search-recent-list" class="search-recent-list" role="list"></div>
  <button type="button" id="search-recent-clear">Clear</button>
</div>
<div id="search-empty" class="search-empty" hidden>
  <p>没有找到结果，试试更短的关键词，或点击上方推荐标签。</p>
</div>
<div id="search-synonym-tip" class="search-synonym-tip" hidden></div>
<textarea id="search-meta-json" hidden>{{ $searchMeta | jsonify }}</textarea>

<script>
  window.addEventListener("DOMContentLoaded", function () {
    if (typeof PagefindUI === "undefined") return;
    var searchUI = new PagefindUI({
      element: "#search",
      showSubResults: true,
      showImages: false,
      resetStyles: false,
      translations: {
        placeholder: "输入关键词搜索",
        clear_search: "清除",
        search_label: "站内搜索"
      }
    });
    void searchUI;
    var searchRoot = document.getElementById("search");
    var filterState = { year: "", tag: "" };
    var synonymMap = {{ $synonyms | jsonify | safeJS }};
    var synonymLookup = {};
    var recentStorageKey = "bluedog_recent_searches_v1";
    var recentMax = 8;
    var recentWrap = document.getElementById("search-recent");
    var recentList = document.getElementById("search-recent-list");
    var recentClear = document.getElementById("search-recent-clear");

    function track(name, props) {
      if (typeof window.BlueDogTrack === "function") {
        window.BlueDogTrack(name, props || {});
      }
    }

    Object.keys(synonymMap || {}).forEach(function (rawKey) {
      var key = String(rawKey || "").trim().toLowerCase();
      if (!key) return;
      var values = Array.isArray(synonymMap[rawKey]) ? synonymMap[rawKey] : [];
      synonymLookup[key] = values
        .map(function (item) {
          return String(item || "").trim();
        })
        .filter(function (item) {
          return item.length > 0;
        });
    });

    function normalizePath(raw) {
      if (!raw) return "";
      try {
        var url = new URL(raw, window.location.origin);
        return url.pathname.endsWith("/") ? url.pathname : url.pathname + "/";
      } catch (error) {
        return "";
      }
    }

    function normalizeTerm(value) {
      return String(value || "")
        .trim()
        .replace(/^#/, "")
        .toLowerCase();
    }

    function splitTerms(query) {
      return String(query || "")
        .split(/[\s,，、]+/)
        .map(function (item) {
          return item.trim();
        })
        .filter(function (item) {
          return item.length > 0;
        });
    }

    function expandQuery(query) {
      var raw = String(query || "").trim();
      if (!raw) return raw;
      var expanded = [];
      var seen = {};

      function pushTerm(term) {
        var clean = String(term || "").trim();
        if (!clean) return;
        var normalized = normalizeTerm(clean);
        if (seen[normalized]) return;
        seen[normalized] = true;
        expanded.push(clean);
      }

      pushTerm(raw);
      splitTerms(raw).forEach(function (term) {
        pushTerm(term);
        var normalized = normalizeTerm(term);
        (synonymLookup[normalized] || []).forEach(pushTerm);
      });
      (synonymLookup[normalizeTerm(raw)] || []).forEach(pushTerm);
      return expanded.join(" ");
    }

    var metaMap = {};
    var metadataScript = document.getElementById("search-meta-json");
    if (metadataScript) {
      try {
        var metadata = JSON.parse(metadataScript.value || metadataScript.textContent || "[]");
        if (Array.isArray(metadata) === false) metadata = [];
        metadata.forEach(function (item) {
          var keys = [item.permalink, item.relPermalink];
          keys.forEach(function (key) {
            var normalized = normalizePath(key);
            if (normalized) {
              metaMap[normalized] = item;
            }
          });
        });
      } catch (error) {
        metaMap = {};
      }
    }

    function showSynonymTip(rawQuery, expandedQuery) {
      var tip = document.getElementById("search-synonym-tip");
      if (!tip) return;
      if (!rawQuery || !expandedQuery || rawQuery === expandedQuery) {
        tip.hidden = true;
        tip.textContent = "";
        return;
      }
      tip.textContent = "已启用同义词扩展: " + rawQuery + " → " + expandedQuery;
      tip.hidden = false;
    }

    function decorateResultHighlights() {
      if (!searchRoot) return;
      searchRoot.querySelectorAll("mark").forEach(function (node) {
        node.classList.add("search-hit");
      });
    }

    function getSearchInput() {
      return document.querySelector("#search input");
    }

    function getFirstResultLink() {
      var results = searchRoot ? searchRoot.querySelectorAll(".pagefind-ui__result") : [];
      for (var i = 0; i < results.length; i++) {
        if (results[i].style.display === "none") continue;
        var link = results[i].querySelector(".pagefind-ui__result-link");
        if (link) return link;
      }
      return null;
    }

    function setInputQuery(value) {
      var input = getSearchInput();
      if (!input) {
        return false;
      }
      input.value = value;
      input.dispatchEvent(new Event("input", { bubbles: true }));
      return true;
    }

    function focusInput() {
      var input = getSearchInput();
      if (!input) return;
      input.focus();
    }

    function getRecentSearches() {
      try {
        var raw = localStorage.getItem(recentStorageKey) || "[]";
        var parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed
          .map(function (item) {
            return String(item || "").trim();
          })
          .filter(function (item) {
            return item.length > 0;
          })
          .slice(0, recentMax);
      } catch (error) {
        return [];
      }
    }

    function renderRecentSearches(inputList) {
      if (!recentWrap || !recentList) return;
      var list = Array.isArray(inputList) ? inputList : getRecentSearches();
      recentList.innerHTML = "";
      if (list.length === 0) {
        recentWrap.hidden = true;
        return;
      }
      list.forEach(function (term) {
        var button = document.createElement("button");
        button.type = "button";
        button.setAttribute("data-recent-query", term);
        button.textContent = term;
        recentList.appendChild(button);
      });
      recentWrap.hidden = false;
    }

    function saveRecentSearch(term) {
      var value = String(term || "").trim();
      if (!value) return;
      var seen = {};
      var next = [value].concat(getRecentSearches()).filter(function (item) {
        var normalized = normalizeTerm(item);
        if (!normalized || seen[normalized]) return false;
        seen[normalized] = true;
        return true;
      });
      next = next.slice(0, recentMax);
      try {
        localStorage.setItem(recentStorageKey, JSON.stringify(next));
      } catch (error) {
        return;
      }
      renderRecentSearches(next);
    }

    function jumpToFirstResult() {
      var firstLink = getFirstResultLink();
      if (!firstLink) return false;
      window.location.href = firstLink.href;
      return true;
    }

    function getResultCounts() {
      if (!searchRoot) return { total: 0, visible: 0 };
      var rows = searchRoot.querySelectorAll(".pagefind-ui__result");
      var visible = 0;
      rows.forEach(function (row) {
        if (row.style.display !== "none") visible += 1;
      });
      return { total: rows.length, visible: visible };
    }

    function updateEmptyState(visibleCount, totalCount) {
      var input = getSearchInput();
      var empty = document.getElementById("search-empty");
      if (!input || !empty) return;
      var keyword = input.value.trim();
      if (!keyword) {
        empty.hidden = true;
        return;
      }

      var counts = getResultCounts();
      var total = typeof totalCount === "number" ? totalCount : counts.total;
      var visible = typeof visibleCount === "number" ? visibleCount : counts.visible;
      if (total === 0) {
        empty.innerHTML = "<p>没有找到结果，试试更短关键词，或点击推荐标签。</p>";
        empty.hidden = false;
        return;
      }
      if (visible === 0) {
        empty.innerHTML = "<p>没有符合筛选条件的结果，请切换 Year/Tag 过滤器。</p>";
        empty.hidden = false;
        return;
      }
      empty.hidden = true;
    }

    function syncFilterButtons() {
      document.querySelectorAll("[data-filter-year]").forEach(function (button) {
        var value = button.getAttribute("data-filter-year") || "";
        button.classList.toggle("is-active", value === filterState.year);
      });
      document.querySelectorAll("[data-filter-tag]").forEach(function (button) {
        var value = button.getAttribute("data-filter-tag") || "";
        button.classList.toggle("is-active", value === filterState.tag);
      });
    }

    function syncFilterParams() {
      var params = new URLSearchParams(window.location.search);
      if (filterState.year) params.set("year", filterState.year);
      else params.delete("year");
      if (filterState.tag) params.set("tag", filterState.tag);
      else params.delete("tag");
      params.delete("autojump");
      var next = params.toString();
      var nextURL = window.location.pathname + (next ? "?" + next : "");
      window.history.replaceState({}, "", nextURL);
    }

    function applyFilters() {
      if (!searchRoot) return;
      var rows = searchRoot.querySelectorAll(".pagefind-ui__result");
      var visible = 0;
      rows.forEach(function (row) {
        var link = row.querySelector(".pagefind-ui__result-link");
        var pass = true;
        if (filterState.year || filterState.tag) {
          var meta = link ? metaMap[normalizePath(link.getAttribute("href"))] : null;
          if (!meta) {
            pass = false;
          } else {
            if (filterState.year && meta.year !== filterState.year) pass = false;
            if (filterState.tag) {
              var tags = Array.isArray(meta.tags) ? meta.tags : [];
              if (tags.indexOf(filterState.tag) === -1) pass = false;
            }
          }
        }
        row.style.display = pass ? "" : "none";
        if (pass) visible += 1;
      });
      updateEmptyState(visible, rows.length);
      decorateResultHighlights();
    }

    function bindInputEvents() {
      var input = getSearchInput();
      if (!input) {
        requestAnimationFrame(bindInputEvents);
        return;
      }
      input.addEventListener("keydown", function (event) {
        if (event.key !== "Enter") return;
        event.preventDefault();
        var userKeyword = input.value.trim();
        var rawKeyword = userKeyword;
        var expandedKeyword = expandQuery(userKeyword);
        if (expandedKeyword && expandedKeyword !== rawKeyword) {
          setInputQuery(expandedKeyword);
          showSynonymTip(rawKeyword, expandedKeyword);
          rawKeyword = expandedKeyword;
        }
        saveRecentSearch(userKeyword || rawKeyword);
        track("search_enter", {
          query: rawKeyword,
          year: filterState.year || "all",
          tag: filterState.tag || "all",
        });
        window.setTimeout(function () {
          if (!jumpToFirstResult()) {
            applyFilters();
          }
        }, 130);
      });
      input.addEventListener("input", function () {
        window.setTimeout(applyFilters, 120);
      });
      focusInput();
    }

    var observer = new MutationObserver(function () {
      applyFilters();
      decorateResultHighlights();
      if (autoJumpRequested) {
        autoJumpRequested = !jumpToFirstResult();
      }
    });
    if (searchRoot) {
      observer.observe(searchRoot, { childList: true, subtree: true });
    }

    var params = new URLSearchParams(window.location.search);
    var initialQuery = params.get("q");
    var autoJumpRequested = params.get("autojump") === "1";
    filterState.year = params.get("year") || "";
    filterState.tag = params.get("tag") || "";
    syncFilterButtons();

    if (initialQuery) {
      var applyQuery = function () {
        var expandedInitial = expandQuery(initialQuery);
        var queryToApply = expandedInitial || initialQuery;
        if (!setInputQuery(queryToApply)) {
          requestAnimationFrame(applyQuery);
          return;
        }
        showSynonymTip(initialQuery, queryToApply);
        focusInput();
        track("search_prefill", {
          query: initialQuery,
          expanded: queryToApply !== initialQuery ? "1" : "0",
        });
        window.setTimeout(function () {
          applyFilters();
          if (autoJumpRequested) {
            autoJumpRequested = !jumpToFirstResult();
          }
        }, 150);
      };
      applyQuery();
    }

    document.querySelectorAll("[data-search-tag]").forEach(function (button) {
      button.addEventListener("click", function () {
        var tag = button.getAttribute("data-search-tag");
        if (!tag) return;
        var expandedTag = expandQuery(tag);
        if (!setInputQuery(expandedTag || tag)) return;
        showSynonymTip(tag, expandedTag);
        saveRecentSearch(tag);
        track("search_quick_tag_click", { tag: tag });
        focusInput();
        window.setTimeout(applyFilters, 120);
      });
    });

    document.querySelectorAll("[data-search-hint]").forEach(function (button) {
      button.addEventListener("click", function () {
        var hint = String(button.getAttribute("data-search-hint") || "");
        var query = hint.split("↔")[0].trim();
        if (!query) return;
        var expanded = expandQuery(query);
        if (!setInputQuery(expanded || query)) return;
        showSynonymTip(query, expanded);
        saveRecentSearch(query);
        track("search_synonym_hint_click", { hint: hint, query: query });
        focusInput();
        window.setTimeout(applyFilters, 120);
      });
    });

    document.querySelectorAll("[data-filter-year]").forEach(function (button) {
      button.addEventListener("click", function () {
        filterState.year = button.getAttribute("data-filter-year") || "";
        syncFilterButtons();
        syncFilterParams();
        track("search_filter_year", { year: filterState.year || "all" });
        applyFilters();
      });
    });

    document.querySelectorAll("[data-filter-tag]").forEach(function (button) {
      button.addEventListener("click", function () {
        filterState.tag = button.getAttribute("data-filter-tag") || "";
        syncFilterButtons();
        syncFilterParams();
        track("search_filter_tag", { tag: filterState.tag || "all" });
        applyFilters();
      });
    });

    if (recentList) {
      recentList.addEventListener("click", function (event) {
        var button = event.target.closest("[data-recent-query]");
        if (!button) return;
        var term = button.getAttribute("data-recent-query") || "";
        if (!term) return;
        if (!setInputQuery(term)) return;
        focusInput();
        track("search_recent_click", { query: term });
        window.setTimeout(applyFilters, 120);
      });
    }

    if (recentClear) {
      recentClear.addEventListener("click", function () {
        try {
          localStorage.removeItem(recentStorageKey);
        } catch (error) {
          return;
        }
        renderRecentSearches([]);
        track("search_recent_clear", {});
      });
    }

    renderRecentSearches();
    bindInputEvents();
    window.setTimeout(applyFilters, 120);
  });
</script>
{{- end }}
